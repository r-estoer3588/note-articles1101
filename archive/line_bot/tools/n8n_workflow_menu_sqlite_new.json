{
  "name": "ãƒ›ã‚²ãƒ¼ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  LINE Bot ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç‰ˆ (SQLite)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "line-menu",
        "options": {}
      },
      "id": "cff1330b-45cf-46e8-8fa1-ad943f002a84",
      "name": "LINE Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        -1472,
        144
      ],
      "webhookId": "c3f01ed6-3497-46c3-9239-9854ad2ba945"
    },
    {
      "parameters": {
        "jsCode": "// LINEã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆbody.eventsã¾ãŸã¯eventsã‚’è©¦ã™ï¼‰\nconst events = $input.item.json.body?.events || $input.item.json.events;\n\nif (!events || events.length === 0) {\n  throw new Error('No events found in webhook data');\n}\n\nconst event = events[0];\nconst text = event.message?.text || '';\nconst userId = event.source?.userId;\nconst replyToken = event.replyToken;\nconst postbackData = event.postback?.data || '';\n\nlet result = {\n  userId: userId,\n  replyToken: replyToken,\n  text: text,\n  postbackData: postbackData,\n  eventType: event.type\n};\n\n// ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒãƒ³ãƒ‰åˆ¤å®š\nif (text.startsWith('menu:')) {\n  const menuAction = text.split(':')[1];\n  result.menuAction = menuAction;\n  result.needsState = true;\n} \n// ãƒã‚¹ãƒˆãƒãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ\nelse if (event.type === 'postback') {\n  const params = new URLSearchParams(postbackData);\n  result.action = params.get('action');\n  result.index = parseInt(params.get('index'));\n  result.needsState = true;\n}\n// é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆçŠ¶æ…‹ä¾å­˜ï¼‰\nelse {\n  result.needsState = true;\n}\n\nreturn { json: result };"
      },
      "id": "a8acf163-476b-4c9f-8263-fcb7e755440f",
      "name": "ã‚³ãƒãƒ³ãƒ‰è§£æ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1280,
        144
      ]
    },
    {
      "parameters": {
        "url": "http://host.docker.internal:5679/api/state/={{ $json.userId }}",
        "options": {}
      },
      "id": "39b438cc-8e23-47f8-8bce-0004de6905fe",
      "name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹å–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1072,
        144
      ]
    },
    {
      "parameters": {
        "jsCode": "const userId = $input.item.json.userId;\nconst menuAction = $input.item.json.menuAction;\nconst text = $input.item.json.text;\nconst action = $input.item.json.action;\nconst eventType = $input.item.json.eventType;\n\n// HTTP Requestã‹ã‚‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹å–å¾—\nconst userState = $node['ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹å–å¾—'].json;\n\n// ãƒ‡ãƒãƒƒã‚°: userStateã®å†…å®¹ã‚’ç¢ºèª\nif (!userState) {\n  throw new Error('userState is null or undefined');\n}\n\nlet result = {\n  userId: userId,\n  replyToken: $input.item.json.replyToken,\n  currentState: userState,\n  nextAction: null,\n  updateState: null\n};\n\n// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†\nif (menuAction) {\n  switch(menuAction) {\n    case 'generate':\n      result.nextAction = 'show_count_selection';\n      result.updateState = { state: 'selecting_count', type: 'buzz' };\n      break;\n      \n    case 'trilogy':\n      result.nextAction = 'show_theme_selection';\n      result.updateState = { state: 'selecting_theme', type: 'trilogy', count: 3 };\n      break;\n      \n    case 'today':\n      const cats = ['æ—¥æ›œ_è¶£å‘³éŠã³', 'æœˆæ›œ_ã‚®ãƒ£ãƒ³ãƒ–ãƒ«é‡‘', 'ç«æ›œ_ãƒ“ã‚¸ãƒã‚¹ã‚­ãƒ£ãƒªã‚¢', 'æ°´æ›œ_ç”Ÿæ´»ç¯€ç´„', 'æœ¨æ›œ_ç¤¾ä¼šãƒãƒƒãƒˆè£äº‹æƒ…', 'é‡‘æ›œ_å¥åº·ç¾å®¹', 'åœŸæ›œ_æ‹æ„›äººé–“é–¢ä¿‚'];\n      const todayTheme = cats[new Date().getDay()];\n      result.nextAction = 'show_count_selection';\n      result.updateState = { state: 'selecting_count', type: 'today', theme: todayTheme };\n      result.todayTheme = todayTheme;\n      break;\n      \n    case 'help':\n      result.nextAction = 'show_help';\n      break;\n  }\n}\n// ãƒã‚¹ãƒˆãƒãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†\nelse if (action) {\n  const posts = userState.posts_data ? JSON.parse(userState.posts_data) : [];\n  const index = $input.item.json.index;\n  \n  switch(action) {\n    case 'next':\n      const nextIndex = (index >= posts.length - 1) ? 0 : index;\n      result.nextAction = 'show_post';\n      result.postContent = posts[nextIndex];\n      result.postIndex = nextIndex;\n      result.totalPosts = posts.length;\n      result.updateState = { current_index: nextIndex };\n      break;\n  }\n}\n// çŠ¶æ…‹ã«å¿œã˜ãŸãƒ†ã‚­ã‚¹ãƒˆå‡¦ç†\nelse if (userState.state === 'selecting_count') {\n  const count = parseInt(text);\n  if (count > 0 && count <= 50) {\n    if (userState.type === 'today') {\n      result.nextAction = 'generate_posts';\n      result.generateParams = {\n        count: count,\n        theme: userState.theme,\n        type: userState.type\n      };\n      result.updateState = { state: 'generating', count: count };\n    } else {\n      result.nextAction = 'show_theme_selection';\n      result.updateState = { state: 'selecting_theme', count: count };\n    }\n  } else {\n    result.nextAction = 'error';\n    result.errorMessage = '1ã€œ50ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';\n  }\n}\nelse if (userState.state === 'selecting_theme') {\n  result.nextAction = 'generate_posts';\n  result.generateParams = {\n    count: userState.count,\n    theme: text,\n    type: userState.type || 'buzz'\n  };\n  result.updateState = { state: 'generating', theme: text };\n}\nelse {\n  result.nextAction = 'show_help';\n}\n\nreturn { json: result };"
      },
      "id": "8942a64d-baf7-4384-b415-da0b1bd4f30f",
      "name": "çŠ¶æ…‹åˆ¤å®š",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -880,
        144
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.nextAction }}",
                    "rightValue": "show_count_selection",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "a9bb0acd-24eb-4f81-979f-675245be8e63",
      "name": "ä»¶æ•°é¸æŠè¡¨ç¤º?",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -672,
        32
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.nextAction }}",
                    "rightValue": "show_theme_selection",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "31842ed4-1914-4d91-a874-d1fe303d6442",
      "name": "ãƒ†ãƒ¼ãƒé¸æŠè¡¨ç¤º?",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -672,
        144
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.nextAction }}",
                    "rightValue": "generate_posts",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "119bfd76-6097-4f8b-87d1-d43300c43331",
      "name": "æŠ•ç¨¿ç”Ÿæˆå®Ÿè¡Œ?",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -672,
        240
      ]
    },
    {
      "parameters": {},
      "id": "745b3426-ff68-4b2b-9049-2d84288a8856",
      "name": "ä»¶æ•°é¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -480,
        32
      ]
    },
    {
      "parameters": {},
      "id": "5cf551fe-2d03-4767-9189-01d535ec1cc6",
      "name": "ãƒ†ãƒ¼ãƒé¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -480,
        144
      ]
    },
    {
      "parameters": {
        "command": "cd c:\\Repos\\note-articles\\tools && python hogey_algorithm.py --count {{ $json.generateParams.count }} --theme \"{{ $json.generateParams.theme }}\" --mode {{ $json.generateParams.type === 'trilogy' ? 'trilogy' : 'buzz' }} --output temp_{{ $json.userId }}.csv"
      },
      "id": "b5d8277d-ae85-43e0-9cfb-3365a8baf922",
      "name": "Pythonå®Ÿè¡Œ",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        -480,
        256
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/reply",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer wC3gxIxXv1YSwIcHr9gSY30+xp8pmF8uPbCsAcNpAnOqI5e6m4VdBI3Dc4/tSg1DOjQdFxYV0285aXsK3mN/Oim0eJuQmnJbD28azHAhfBrxEFosh9kdykEMm9rbeMOpiMCKsQnP2Cg2g8S7girINwdB04t89/1O/w1cDnyilFU="
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { replyToken: $json.replyToken, messages: [$json.message] } }}",
        "options": {}
      },
      "id": "d3dc9d92-5f4c-4f5c-bbd0-b26504ad22f5",
      "name": "LINEè¿”ä¿¡",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -80,
        144
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:5679/api/state/={{ $json.userId }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.updateState) }}",
        "options": {}
      },
      "id": "05506993-76ea-4dc0-a4e3-86104b9b6d71",
      "name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹æ›´æ–°",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -272,
        144
      ]
    },
    {
      "parameters": {},
      "id": "8ff63f5a-150d-453a-95ef-d74adbdc4bef",
      "name": "æŠ•ç¨¿è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -272,
        256
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.nextAction }}",
                    "rightValue": "show_help",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "4bfd0e4e-5be3-4364-b659-fc19e7898616",
      "name": "ãƒ˜ãƒ«ãƒ—è¡¨ç¤º?",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -672,
        336
      ]
    },
    {
      "parameters": {
        "jsCode": "const userId = $input.item.json.userId;\nconst replyToken = $input.item.json.replyToken;\n\nconst helpMessage = {\n  type: \"text\",\n  text: \"ğŸ¶ ãƒ›ã‚²ãƒ¼ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ \\n\\nä½¿ã„æ–¹:\\n1. ã€Œmenu:generateã€ã§æŠ•ç¨¿ç”Ÿæˆ\\n2. ã€Œmenu:todayã€ã§ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒ\\n3. ã€Œmenu:helpã€ã§ãƒ˜ãƒ«ãƒ—\\n\\nä»¶æ•°ã¨ãƒ†ãƒ¼ãƒã‚’é¸æŠã—ã¦æŠ•ç¨¿ã‚’ç”Ÿæˆã—ã¾ã™ã€‚\"\n};\n\nreturn {\n  json: {\n    userId: userId,\n    replyToken: replyToken,\n    message: helpMessage\n  }\n};"
      },
      "id": "519a183a-e1f8-411f-b7f7-c32b8578343b",
      "name": "ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -480,
        336
      ]
    },
    {
      "parameters": {
        "jsCode": "const userId = $input.item.json.userId;\nconst replyToken = $input.item.json.replyToken;\nconst generateParams = $input.item.json.generateParams;\n\nconst loadingMessage = {\n  type: \"text\",\n  text: \"â³ æŠ•ç¨¿ã‚’ç”Ÿæˆä¸­...\\n\\nãƒ†ãƒ¼ãƒ: \" + generateParams.theme + \"\\nä»¶æ•°: \" + generateParams.count + \"ä»¶\"\n};\n\nreturn {\n  json: {\n    userId: userId,\n    replyToken: replyToken,\n    message: loadingMessage,\n    generateParams: generateParams\n  }\n};"
      },
      "id": "34442ecc-9ad5-4db5-9103-50c572deab6b",
      "name": "ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -480,
        240
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "LINE Webhook": {
      "main": [
        [
          {
            "node": "ã‚³ãƒãƒ³ãƒ‰è§£æ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚³ãƒãƒ³ãƒ‰è§£æ": {
      "main": [
        [
          {
            "node": "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹å–å¾—": {
      "main": [
        [
          {
            "node": "çŠ¶æ…‹åˆ¤å®š",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "çŠ¶æ…‹åˆ¤å®š": {
      "main": [
        [
          {
            "node": "ä»¶æ•°é¸æŠè¡¨ç¤º?",
            "type": "main",
            "index": 0
          },
          {
            "node": "ãƒ†ãƒ¼ãƒé¸æŠè¡¨ç¤º?",
            "type": "main",
            "index": 0
          },
          {
            "node": "æŠ•ç¨¿ç”Ÿæˆå®Ÿè¡Œ?",
            "type": "main",
            "index": 0
          },
          {
            "node": "ãƒ˜ãƒ«ãƒ—è¡¨ç¤º?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä»¶æ•°é¸æŠè¡¨ç¤º?": {
      "main": [
        [
          {
            "node": "ä»¶æ•°é¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ†ãƒ¼ãƒé¸æŠè¡¨ç¤º?": {
      "main": [
        [
          {
            "node": "ãƒ†ãƒ¼ãƒé¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æŠ•ç¨¿ç”Ÿæˆå®Ÿè¡Œ?": {
      "main": [
        [
          {
            "node": "ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ˜ãƒ«ãƒ—è¡¨ç¤º?": {
      "main": [
        [
          {
            "node": "ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸": {
      "main": [
        [
          {
            "node": "LINEè¿”ä¿¡",
            "type": "main",
            "index": 0
          },
          {
            "node": "Pythonå®Ÿè¡Œ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä»¶æ•°é¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ": {
      "main": [
        [
          {
            "node": "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹æ›´æ–°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ†ãƒ¼ãƒé¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ": {
      "main": [
        [
          {
            "node": "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹æ›´æ–°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ": {
      "main": [
        [
          {
            "node": "LINEè¿”ä¿¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pythonå®Ÿè¡Œ": {
      "main": [
        [
          {
            "node": "æŠ•ç¨¿è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æŠ•ç¨¿è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ": {
      "main": [
        [
          {
            "node": "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹æ›´æ–°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹æ›´æ–°": {
      "main": [
        [
          {
            "node": "LINEè¿”ä¿¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "40499607-325e-4224-bf0c-dfb79aa763ac",
  "meta": {
    "instanceId": "2540e56e49eb088925e01910351788944bfe79648cfc8674ed90d1d41fe01fc2"
  },
  "id": "VIYo5WcepmI3rmcJ",
  "tags": []
}