services:
  n8n:
    image: n8nio/n8n:1.117.3
    container_name: n8n-notes-organizer
    restart: always
    ports:
      - "5678:5678"
    environment:
      # 基本認証(セキュリティのため)
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=change_this_password_123
      
      # タイムゾーン
      - GENERIC_TIMEZONE=Asia/Tokyo
      - TZ=Asia/Tokyo
      
      # セキュリティ設定
      - N8N_SECURE_COOKIE=false
      
      # パフォーマンス設定
      - EXECUTIONS_PROCESS=main
      - EXECUTIONS_MODE=regular
      
      # ログレベル
      - N8N_LOG_LEVEL=info
      
      # OpenAI API キー（環境変数経由で Code ノードからアクセス可能）
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      # 🔑 重要: n8nの全設定を永続化
      # ここに以下が保存される:
      # - ワークフロー
      # - Credentials (API キー)
      # - 実行履歴
      # - 設定ファイル
      - n8n_data:/home/node/.n8n
      
      # ノートフォルダをDockerコンテナ内にマウント
      # Windows の場合、ドライブレター（C:）は小文字で、バックスラッシュはフォワードスラッシュに
      - C:/Notes:/notes:ro
      
    networks:
      - n8n-network
    
    # ヘルスチェック(オプションだが推奨)
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:5678/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  # 🔒 永続化ボリューム
  # このボリュームを削除しない限り、設定は永久に保存される
  n8n_data:
    driver: local

networks:
  n8n-network:
    driver: bridge
