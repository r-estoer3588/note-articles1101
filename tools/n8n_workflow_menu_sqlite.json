{
  "name": "ãƒ›ã‚²ãƒ¼ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  LINE Bot ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç‰ˆ (SQLite)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "line-menu",
        "options": {}
      },
      "id": "f5ecdebc-c7a3-4aab-9434-82d3055494a2",
      "name": "LINE Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        -1744,
        80
      ],
      "webhookId": "c3f01ed6-3497-46c3-9239-9854ad2ba945"
    },
    {
      "parameters": {
  "jsCode": "// LINEã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆbody.eventsã¾ãŸã¯eventsã‚’è©¦ã™ï¼‰\nconst events = $input.item.json.body?.events || $input.item.json.events;\n\nif (!events || events.length === 0) {\n  throw new Error('No events found in webhook data');\n}\n\nconst event = events[0];\nconst rawText = event.message?.text || '';\nconst text = rawText.trim();\nconst lowerText = text.toLowerCase();\nconst userId = event.source?.userId;\nconst replyToken = event.replyToken;\nconst postbackData = event.postback?.data || '';\n\n// å…¨è§’â†’åŠè§’æ­£è¦åŒ–ï¼ˆæ•°å­—ãƒ»ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆï¼‰\nconst normalizeDigits = (value) => value.replace(/[ï¼-ï¼™]/g, (d) => String.fromCharCode(d.charCodeAt(0) - 0xFEE0));\nconst normalizeAlpha = (value) => value.replace(/[ï¼¡-ï¼º]/g, (d) => String.fromCharCode(d.charCodeAt(0) - 0xFEE0));\nconst digitOnly = normalizeDigits(text).replace(/[^0-9]/g, '');\nconst alphaOnly = normalizeAlpha(text).replace(/[^A-Za-z]/g, '').toLowerCase();\n\nlet result = {\n  userId: userId,\n  replyToken: replyToken,\n  text: text,\n  originalText: rawText,\n  postbackData: postbackData,\n  eventType: event.type\n};\n\nconst setMenuAction = (action) => {\n  result.menuAction = action;\n  // canonical text ã«çµ±ä¸€ï¼ˆä¸‹æµã§ menu:* ã‚’æ¡ä»¶åˆ¤å®šã—ã‚„ã™ãã™ã‚‹ï¼‰\n  result.text = 'menu:' + action;\n  result.needsState = true;\n};\n\n// 1) æ˜ç¤ºçš„ãª menu: ã‚³ãƒãƒ³ãƒ‰\nif (lowerText.startsWith('menu:')) {\n  const menuAction = lowerText.split(':')[1];\n  setMenuAction(menuAction);\n}\n// 2) a/b/c ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ ï¼ˆæ•°å­—ã¯ä»¶æ•°é¸æŠãƒ•ã‚§ãƒ¼ã‚ºã§ä½¿ã†ãŸã‚é™¤å¤–ï¼‰\nelse if (alphaOnly.length === 1 && ['a','b','c'].includes(alphaOnly)) {\n  const mapping = { a: 'generate', b: 'today', c: 'help' };\n  setMenuAction(mapping[alphaOnly]);\n}\n// 3) ãƒã‚¹ãƒˆãƒãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ\nelse if (event.type === 'postback') {\n  const params = new URLSearchParams(postbackData);\n  result.action = params.get('action');\n  result.index = parseInt(params.get('index'));\n  result.needsState = true;\n}\n// 4) ä¸Šè¨˜ä»¥å¤–ã¯çŠ¶æ…‹ã«å¿œã˜ã¦åˆ¤å®šï¼ˆä»¶æ•°/ãƒ†ãƒ¼ãƒãªã©ï¼‰\nelse {\n  result.needsState = true;\n}\n\nreturn { json: result };"
      },
      "id": "7a5dccf6-b144-4923-b83e-c8cf40ef4033",
      "name": "ã‚³ãƒãƒ³ãƒ‰è§£æ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1552,
        80
      ]
    },
    {
      "parameters": {
        "url": "http://host.docker.internal:5679/api/state/={{ $json.userId }}",
        "options": {}
      },
      "id": "4bee573c-6d42-40fe-8025-aa5ff0794ace",
      "name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹å–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1344,
        80
      ]
    },
    {
      "parameters": {
  "jsCode": "const userId = $input.item.json.userId;\nconst menuAction = $input.item.json.menuAction;\nconst text = $input.item.json.text;\nconst action = $input.item.json.action;\nconst eventType = $input.item.json.eventType;\n\n// ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹å–å¾— (å¤±æ•—æ™‚ã¯åˆæœŸçŠ¶æ…‹ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)\nconst userStateRaw = $node['ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹å–å¾—'].json;\nlet userState = userStateRaw;\nif (!userState || userState.error) {\n  userState = { state: 'initial' };\n}\n\nlet result = {\n  userId,\n  replyToken: $input.item.json.replyToken,\n  currentState: userState,\n  nextAction: null,\n  updateState: null\n};\n\n// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†\nif (menuAction) {\n  switch(menuAction) {\n    case 'generate':\n      result.nextAction = 'show_count_selection';\n      result.updateState = { state: 'selecting_count', type: 'buzz' };\n      break;\n    case 'trilogy':\n      result.nextAction = 'show_theme_selection';\n      result.updateState = { state: 'selecting_theme', type: 'trilogy', count: 3 };\n      break;\n    case 'today':\n      const cats = ['æ—¥æ›œ_è¶£å‘³éŠã³', 'æœˆæ›œ_ã‚®ãƒ£ãƒ³ãƒ–ãƒ«é‡‘', 'ç«æ›œ_ãƒ“ã‚¸ãƒã‚¹ã‚­ãƒ£ãƒªã‚¢', 'æ°´æ›œ_ç”Ÿæ´»ç¯€ç´„', 'æœ¨æ›œ_ç¤¾ä¼šãƒãƒƒãƒˆè£äº‹æƒ…', 'é‡‘æ›œ_å¥åº·ç¾å®¹', 'åœŸæ›œ_æ‹æ„›äººé–“é–¢ä¿‚'];\n      const todayTheme = cats[new Date().getDay()];\n      result.nextAction = 'show_count_selection';\n      result.updateState = { state: 'selecting_count', type: 'today', theme: todayTheme };\n      result.todayTheme = todayTheme;\n      break;\n    case 'help':\n      result.nextAction = 'show_help';\n      break;\n  }\n}\n// ãƒã‚¹ãƒˆãƒãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†\nelse if (action) {\n  const posts = userState.posts_data ? JSON.parse(userState.posts_data) : [];\n  const index = $input.item.json.index;\n  switch(action) {\n    case 'next':\n      const nextIndex = (index >= posts.length - 1) ? 0 : index;\n      result.nextAction = 'show_post';\n      result.postContent = posts[nextIndex];\n      result.postIndex = nextIndex;\n      result.totalPosts = posts.length;\n      result.updateState = { current_index: nextIndex };\n      break;\n  }\n}\n// çŠ¶æ…‹ã«å¿œã˜ãŸãƒ†ã‚­ã‚¹ãƒˆå‡¦ç†\nelse if (userState.state === 'selecting_count') {\n  const count = parseInt(text);\n  if (count > 0 && count <= 50) {\n    if (userState.type === 'today') {\n      result.nextAction = 'generate_posts';\n      result.generateParams = { count, theme: userState.theme, type: userState.type };\n      result.updateState = { state: 'generating', count };\n    } else {\n      result.nextAction = 'show_theme_selection';\n      result.updateState = { state: 'selecting_theme', count };\n    }\n  } else {\n    result.nextAction = 'error';\n    result.errorMessage = '1ã€œ50ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';\n  }\n}\nelse if (userState.state === 'selecting_theme') {\n  result.nextAction = 'generate_posts';\n  result.generateParams = { count: userState.count, theme: text, type: userState.type || 'buzz' };\n  result.updateState = { state: 'generating', theme: text };\n}\nelse {\n  // åˆæœŸçŠ¶æ…‹ã§ã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼æœªé¸æŠ -> ãƒ˜ãƒ«ãƒ—ã‚’è¿”ã™\n  result.nextAction = 'show_help';\n}\n\nreturn { json: result };"
      },
      "id": "0516f188-f035-4a7a-8f15-65d09c106184",
      "name": "çŠ¶æ…‹åˆ¤å®š",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1152,
        80
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.nextAction }}",
                    "rightValue": "show_count_selection",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": false
            }
          ]
        },
        "options": {}
      },
      "id": "3624d4ba-07c6-4d27-bc91-96b6ba3ed5dc",
      "name": "ä»¶æ•°é¸æŠè¡¨ç¤º?",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -944,
        -32
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.nextAction }}",
                    "rightValue": "show_theme_selection",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": false
            }
          ]
        },
        "options": {}
      },
      "id": "1f0e25f0-c987-43f1-a9f4-1fb3acc4bce1",
      "name": "ãƒ†ãƒ¼ãƒé¸æŠè¡¨ç¤º?",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -944,
        80
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.nextAction }}",
                    "rightValue": "generate_posts",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": false
            }
          ]
        },
        "options": {}
      },
      "id": "fee4f84d-937d-4bac-bd1d-6fb80f7bc125",
      "name": "æŠ•ç¨¿ç”Ÿæˆå®Ÿè¡Œ?",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -944,
        176
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = { ...$input.item.json };\nconst userId = input.userId;\nlet replyToken = input.replyToken;\nif (!replyToken) {\n  const fallbackNodes = ['çŠ¶æ…‹åˆ¤å®š', 'ã‚³ãƒãƒ³ãƒ‰è§£æ'];\n  for (const name of fallbackNodes) {\n    try {\n      const data = $node[name]?.json;\n      if (data?.replyToken) {\n        replyToken = data.replyToken;\n        break;\n      }\n    } catch (err) {\n      continue;\n    }\n  }\n}\n\nif (!replyToken) {\n  throw new Error('replyToken missing for count selection');\n}\n\nconst todayTheme = input.todayTheme || '';\n\nlet messageText = \"ä½•ä»¶ã®æŠ•ç¨¿ã‚’ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ\\n\\n1ã€œ50ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\";\nif (todayTheme) {\n  messageText = `ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒ: ${todayTheme}\\n\\nä½•ä»¶ã®æŠ•ç¨¿ã‚’ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ\\n\\n1ã€œ50ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`;\n}\n\nconst message = {\n  type: \"text\",\n  text: messageText\n};\n\nconst payload = { ...input };\npayload.replyToken = replyToken;\npayload.userId = userId;\ndelete payload.message;\npayload.messages = [message];\n\nreturn { json: payload };"
      },
      "id": "7f7f2abd-67cd-4697-9f73-6a374adfe753",
      "name": "ä»¶æ•°é¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -752,
        -32
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = { ...$input.item.json };\nconst userId = input.userId;\nlet replyToken = input.replyToken;\nif (!replyToken) {\n  const fallbackNodes = ['çŠ¶æ…‹åˆ¤å®š', 'ã‚³ãƒãƒ³ãƒ‰è§£æ'];\n  for (const name of fallbackNodes) {\n    try {\n      const data = $node[name]?.json;\n      if (data?.replyToken) {\n        replyToken = data.replyToken;\n        break;\n      }\n    } catch (err) {\n      continue;\n    }\n  }\n}\n\nif (!replyToken) {\n  throw new Error('replyToken missing for theme selection');\n}\n\nconst count = input.updateState?.count || '';\n\nconst message = {\n  type: \"text\",\n  text: `${count}ä»¶ã®æŠ•ç¨¿ã‚’ç”Ÿæˆã—ã¾ã™ã€‚\\n\\nãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\\n\\nä¾‹: ãƒ“ã‚¸ãƒã‚¹ã€æ‹æ„›ã€ãŠé‡‘ã€å¥åº· ãªã©`\n};\n\nconst payload = { ...input };\npayload.replyToken = replyToken;\npayload.userId = userId;\ndelete payload.message;\npayload.messages = [message];\n\nreturn { json: payload };"
      },
      "id": "9fb34c53-28a7-4a3c-bbb3-0f64a394ffdd",
      "name": "ãƒ†ãƒ¼ãƒé¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -752,
        80
      ]
    },
    {
      "parameters": {
        "command": "cd c:\\Repos\\note-articles\\tools && python hogey_algorithm.py --count {{ $json.generateParams.count }} --theme \"{{ $json.generateParams.theme }}\" --mode {{ $json.generateParams.type === 'trilogy' ? 'trilogy' : 'buzz' }} --output temp_{{ $json.userId }}.csv"
      },
      "id": "7932a5b3-43be-43e0-ae81-318e7f2f438c",
      "name": "Pythonå®Ÿè¡Œ",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        -752,
        192
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/reply",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer wC3gxIxXv1YSwIcHr9gSY30+xp8pmF8uPbCsAcNpAnOqI5e6m4VdBI3Dc4/tSg1DOjQdFxYV0285aXsK3mN/Oim0eJuQmnJbD28azHAhfBrxEFosh9kdykEMm9rbeMOpiMCKsQnP2Cg2g8S7girINwdB04t89/1O/w1cDnyilFU="
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
  "sendBody": true,
  "specifyBody": "json",
  "jsonBody": "={{ ({ replyToken: $json.replyToken, messages: $json.messages }) }}",
        "options": {}
      },
      "id": "db6c5dc1-ae40-449c-a876-d1d84e7fbe9c",
      "name": "LINEè¿”ä¿¡",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -352,
        80
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:5679/api/state/={{ $json.userId }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.updateState) }}",
        "options": {}
      },
      "id": "400e01c0-8145-4c1a-ac12-a87b361fa3d5",
      "name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹æ›´æ–°",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -544,
        80
      ]
    },
    {
      "parameters": {
        "jsCode": "// Pythonå®Ÿè¡Œå¾Œã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§æŠ•ç¨¿ã‚’è¡¨ç¤º\nconst input = { ...$input.item.json };\nconst userId = input.userId;\nlet replyToken = input.replyToken;\nif (!replyToken) {\n  const fallbackNodes = ['ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', 'çŠ¶æ…‹åˆ¤å®š', 'ã‚³ãƒãƒ³ãƒ‰è§£æ'];\n  for (const name of fallbackNodes) {\n    try {\n      const data = $node[name]?.json;\n      if (data?.replyToken) {\n        replyToken = data.replyToken;\n        break;\n      }\n    } catch (err) {\n      continue;\n    }\n  }\n}\n\nif (!replyToken) {\n  throw new Error('replyToken missing for post display');\n}\n\nconst generateParams = input.generateParams;\n\n// Pythonå®Ÿè¡Œã®çµæœã‹ã‚‰CSVå†…å®¹ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€\n// ã¨ã‚Šã‚ãˆãšå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™\nconst message = {\n  type: \"text\",\n  text: `âœ… ${generateParams.count}ä»¶ã®æŠ•ç¨¿ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼\\n\\nãƒ†ãƒ¼ãƒ: ${generateParams.theme}`\n};\n\nconst payload = { ...input };\npayload.replyToken = replyToken;\npayload.userId = userId;\ndelete payload.message;\npayload.messages = [message];\n\nreturn { json: payload };"
      },
      "id": "7a1233ca-b42b-4b39-9222-6a0f7062c8b3",
      "name": "æŠ•ç¨¿è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -544,
        192
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.nextAction }}",
                    "rightValue": "show_help",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": false
            }
          ]
        },
        "options": {}
      },
      "id": "b9e490e4-b36e-452c-9d26-3a42dd0c7d0f",
      "name": "ãƒ˜ãƒ«ãƒ—è¡¨ç¤º?",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -944,
        272
      ]
    },
    {
      "parameters": {
  "jsCode": "const input = { ...$input.item.json };\nconst userId = input.userId;\nlet replyToken = input.replyToken;\nif (!replyToken) {\n  const fallbackNodes = ['çŠ¶æ…‹åˆ¤å®š', 'ã‚³ãƒãƒ³ãƒ‰è§£æ'];\n  for (const name of fallbackNodes) {\n    try {\n      const data = $node[name]?.json;\n      if (data?.replyToken) {\n        replyToken = data.replyToken;\n        break;\n      }\n    } catch (err) {\n      continue;\n    }\n  }\n}\n\nif (!replyToken) {\n  throw new Error('replyToken missing for help message');\n}\n\nconst helpMessage = {\n  type: \"text\",\n  text: \"ğŸ¶ ãƒ›ã‚²ãƒ¼ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ \\n\\nä½¿ã„æ–¹:ï¼ˆA/B/C ã‹ ãƒœã‚¿ãƒ³ï¼‰\\nA. menu:generate â†’ æŠ•ç¨¿ç”Ÿæˆ\\nB. menu:today â†’ ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒ\\nC. menu:help â†’ ãƒ˜ãƒ«ãƒ—\\n\\nä»¶æ•°ã¯ 1ã€œ50 ã®åŠè§’/å…¨è§’æ•°å­—ã§å…¥åŠ›ï¼ˆA,B,C ã¯ä»¶æ•°ã§ã¯ãªããƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ã€‚\",\n  quickReply: {\n    items: [\n      { type: 'action', action: { type: 'message', label: 'A. æŠ•ç¨¿ç”Ÿæˆ', text: 'menu:generate' } },\n      { type: 'action', action: { type: 'message', label: 'B. ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒ', text: 'menu:today' } },\n      { type: 'action', action: { type: 'message', label: 'C. ãƒ˜ãƒ«ãƒ—', text: 'menu:help' } }\n    ]\n  }\n};\n\nconst payload = { ...input };\npayload.replyToken = replyToken;\npayload.userId = userId;\ndelete payload.message;\npayload.messages = [helpMessage];\n\nreturn { json: payload };"
      },
      "id": "e3aae550-fcfa-45ee-ab85-166206aab040",
      "name": "ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -752,
        272
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = { ...$input.item.json };\nconst userId = input.userId;\nlet replyToken = input.replyToken;\nif (!replyToken) {\n  const fallbackNodes = ['çŠ¶æ…‹åˆ¤å®š', 'ã‚³ãƒãƒ³ãƒ‰è§£æ'];\n  for (const name of fallbackNodes) {\n    try {\n      const data = $node[name]?.json;\n      if (data?.replyToken) {\n        replyToken = data.replyToken;\n        break;\n      }\n    } catch (err) {\n      continue;\n    }\n  }\n}\n\nif (!replyToken) {\n  throw new Error('replyToken missing for loading message');\n}\n\nconst generateParams = input.generateParams;\n\nconst loadingMessage = {\n  type: \"text\",\n  text: \"â³ æŠ•ç¨¿ã‚’ç”Ÿæˆä¸­...\\n\\nãƒ†ãƒ¼ãƒ: \" + generateParams.theme + \"\\nä»¶æ•°: \" + generateParams.count + \"ä»¶\"\n};\n\nconst payload = { ...input };\npayload.replyToken = replyToken;\npayload.userId = userId;\ndelete payload.message;\npayload.messages = [loadingMessage];\n\nreturn { json: payload };"
      },
      "id": "bf25f1d9-e140-4665-9a94-1814f0d63f02",
      "name": "ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -752,
        176
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "LINE Webhook": {
      "main": [
        [
          {
            "node": "ã‚³ãƒãƒ³ãƒ‰è§£æ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ã‚³ãƒãƒ³ãƒ‰è§£æ": {
      "main": [
        [
          {
            "node": "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹å–å¾—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹å–å¾—": {
      "main": [
        [
          {
            "node": "çŠ¶æ…‹åˆ¤å®š",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "çŠ¶æ…‹åˆ¤å®š": {
      "main": [
        [
          {
            "node": "ä»¶æ•°é¸æŠè¡¨ç¤º?",
            "type": "main",
            "index": 0
          },
          {
            "node": "ãƒ†ãƒ¼ãƒé¸æŠè¡¨ç¤º?",
            "type": "main",
            "index": 0
          },
          {
            "node": "æŠ•ç¨¿ç”Ÿæˆå®Ÿè¡Œ?",
            "type": "main",
            "index": 0
          },
          {
            "node": "ãƒ˜ãƒ«ãƒ—è¡¨ç¤º?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä»¶æ•°é¸æŠè¡¨ç¤º?": {
      "main": [
        [
          {
            "node": "ä»¶æ•°é¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ†ãƒ¼ãƒé¸æŠè¡¨ç¤º?": {
      "main": [
        [
          {
            "node": "ãƒ†ãƒ¼ãƒé¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æŠ•ç¨¿ç”Ÿæˆå®Ÿè¡Œ?": {
      "main": [
        [
          {
            "node": "ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ˜ãƒ«ãƒ—è¡¨ç¤º?": {
      "main": [
        [
          {
            "node": "ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸": {
      "main": [
        [
          {
            "node": "LINEè¿”ä¿¡",
            "type": "main",
            "index": 0
          },
          {
            "node": "Pythonå®Ÿè¡Œ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä»¶æ•°é¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ": {
      "main": [
        [
          {
            "node": "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹æ›´æ–°",
            "type": "main",
            "index": 0
          },
          {
            "node": "LINEè¿”ä¿¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ†ãƒ¼ãƒé¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ": {
      "main": [
        [
          {
            "node": "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹æ›´æ–°",
            "type": "main",
            "index": 0
          },
          {
            "node": "LINEè¿”ä¿¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ": {
      "main": [
        [
          {
            "node": "LINEè¿”ä¿¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pythonå®Ÿè¡Œ": {
      "main": [
        [
          {
            "node": "æŠ•ç¨¿è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æŠ•ç¨¿è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ": {
      "main": [
        [
          {
            "node": "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹æ›´æ–°",
            "type": "main",
            "index": 0
          },
          {
            "node": "LINEè¿”ä¿¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹æ›´æ–°": {}
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "31e29457-dec3-4fd5-a927-ab1d0d5b91a9",
  "meta": {
    "instanceId": "2540e56e49eb088925e01910351788944bfe79648cfc8674ed90d1d41fe01fc2"
  },
  "id": "VIYo5WcepmI3rmcJ",
  "tags": []
}