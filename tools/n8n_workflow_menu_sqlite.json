{
  "name": "ãƒ›ã‚²ãƒ¼ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  LINE Bot ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç‰ˆ (SQLite)",
  "nodes": [
    {
      "parameters": {
        "path": "line-menu"
      },
      "id": "webhook-line",
      "name": "LINE Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "functionCode": "// LINEã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆbody.eventsã¾ãŸã¯eventsã‚’è©¦ã™ï¼‰\nconst events = $input.item.json.body?.events || $input.item.json.events;\n\nif (!events || events.length === 0) {\n  throw new Error('No events found in webhook data');\n}\n\nconst event = events[0];\nconst text = event.message?.text || '';\nconst userId = event.source?.userId;\nconst replyToken = event.replyToken;\nconst postbackData = event.postback?.data || '';\n\nlet result = {\n  userId: userId,\n  replyToken: replyToken,\n  text: text,\n  postbackData: postbackData,\n  eventType: event.type\n};\n\n// ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒãƒ³ãƒ‰åˆ¤å®š\nif (text.startsWith('menu:')) {\n  const menuAction = text.split(':')[1];\n  result.menuAction = menuAction;\n  result.needsState = true;\n} \n// ãƒã‚¹ãƒˆãƒãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ\nelse if (event.type === 'postback') {\n  const params = new URLSearchParams(postbackData);\n  result.action = params.get('action');\n  result.index = parseInt(params.get('index'));\n  result.needsState = true;\n}\n// é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆçŠ¶æ…‹ä¾å­˜ï¼‰\nelse {\n  result.needsState = true;\n}\n\nreturn { json: result };"
      },
      "id": "parse-command",
      "name": "ã‚³ãƒãƒ³ãƒ‰è§£æ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://host.docker.internal:5679/api/state/={{ $json.userId }}",
        "options": {}
      },
      "id": "get-user-state",
      "name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹å–å¾—",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "functionCode": "const userId = $input.item.json.userId;\nconst menuAction = $input.item.json.menuAction;\nconst text = $input.item.json.text;\nconst action = $input.item.json.action;\nconst eventType = $input.item.json.eventType;\n\n// HTTP Requestã‹ã‚‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹å–å¾—\nconst userState = $node['ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹å–å¾—'].json;\n\nlet result = {\n  userId: userId,\n  replyToken: $input.item.json.replyToken,\n  currentState: userState,\n  nextAction: null,\n  updateState: null\n};\n\n// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†\nif (menuAction) {\n  switch(menuAction) {\n    case 'generate':\n      result.nextAction = 'show_count_selection';\n      result.updateState = { state: 'selecting_count', type: 'buzz' };\n      break;\n      \n    case 'trilogy':\n      result.nextAction = 'show_theme_selection';\n      result.updateState = { state: 'selecting_theme', type: 'trilogy', count: 3 };\n      break;\n      \n    case 'today':\n      const cats = ['æ—¥æ›œ_è¶£å‘³éŠã³', 'æœˆæ›œ_ã‚®ãƒ£ãƒ³ãƒ–ãƒ«é‡‘', 'ç«æ›œ_ãƒ“ã‚¸ãƒã‚¹ã‚­ãƒ£ãƒªã‚¢', 'æ°´æ›œ_ç”Ÿæ´»ç¯€ç´„', 'æœ¨æ›œ_ç¤¾ä¼šãƒãƒƒãƒˆè£äº‹æƒ…', 'é‡‘æ›œ_å¥åº·ç¾å®¹', 'åœŸæ›œ_æ‹æ„›äººé–“é–¢ä¿‚'];\n      const todayTheme = cats[new Date().getDay()];\n      result.nextAction = 'show_count_selection';\n      result.updateState = { state: 'selecting_count', type: 'today', theme: todayTheme };\n      result.todayTheme = todayTheme;\n      break;\n      \n    case 'help':\n      result.nextAction = 'show_help';\n      break;\n  }\n}\n// ãƒã‚¹ãƒˆãƒãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†\nelse if (action) {\n  const posts = userState.posts_data ? JSON.parse(userState.posts_data) : [];\n  const index = $input.item.json.index;\n  \n  switch(action) {\n    case 'next':\n      const nextIndex = (index >= posts.length - 1) ? 0 : index;\n      result.nextAction = 'show_post';\n      result.postContent = posts[nextIndex];\n      result.postIndex = nextIndex;\n      result.totalPosts = posts.length;\n      result.updateState = { current_index: nextIndex };\n      break;\n  }\n}\n// çŠ¶æ…‹ã«å¿œã˜ãŸãƒ†ã‚­ã‚¹ãƒˆå‡¦ç†\nelse if (userState.state === 'selecting_count') {\n  const count = parseInt(text);\n  if (count > 0 && count <= 50) {\n    if (userState.type === 'today') {\n      result.nextAction = 'generate_posts';\n      result.generateParams = {\n        count: count,\n        theme: userState.theme,\n        type: userState.type\n      };\n      result.updateState = { state: 'generating', count: count };\n    } else {\n      result.nextAction = 'show_theme_selection';\n      result.updateState = { state: 'selecting_theme', count: count };\n    }\n  } else {\n    result.nextAction = 'error';\n    result.errorMessage = '1ã€œ50ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';\n  }\n}\nelse if (userState.state === 'selecting_theme') {\n  result.nextAction = 'generate_posts';\n  result.generateParams = {\n    count: userState.count,\n    theme: text,\n    type: userState.type || 'buzz'\n  };\n  result.updateState = { state: 'generating', theme: text };\n}\nelse {\n  result.nextAction = 'show_help';\n}\n\nreturn { json: result };"
      },
      "id": "state-machine",
      "name": "çŠ¶æ…‹åˆ¤å®š",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.nextAction }}",
              "value2": "show_count_selection"
            }
          ]
        }
      },
      "id": "switch-action-count",
      "name": "ä»¶æ•°é¸æŠè¡¨ç¤º?",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [1050, 200]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.nextAction }}",
              "value2": "show_theme_selection"
            }
          ]
        }
      },
      "id": "switch-action-theme",
      "name": "ãƒ†ãƒ¼ãƒé¸æŠè¡¨ç¤º?",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.nextAction }}",
              "value2": "generate_posts"
            }
          ]
        }
      },
      "id": "switch-action-generate",
      "name": "æŠ•ç¨¿ç”Ÿæˆå®Ÿè¡Œ?",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "functionCode": "const type = $input.item.json.currentState.type;\nconst todayTheme = $input.item.json.todayTheme;\n\nlet message = {\n  type: 'text',\n  text: 'ä½•ä»¶ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ',\n  quickReply: {\n    items: [\n      { type: 'action', action: { type: 'message', label: '3ä»¶', text: '3' } },\n      { type: 'action', action: { type: 'message', label: '5ä»¶', text: '5' } },\n      { type: 'action', action: { type: 'message', label: '10ä»¶', text: '10' } },\n      { type: 'action', action: { type: 'message', label: '20ä»¶', text: '20' } }\n    ]\n  }\n};\n\nif (type === 'today') {\n  message.text = `ğŸ“š ä»Šæ—¥ã¯ã€Œ${todayTheme}ã€ã®ãƒ†ãƒ¼ãƒã§ã™\\nä½•ä»¶ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ`;\n}\n\nreturn { json: { replyToken: $input.item.json.replyToken, message: message, userId: $input.item.json.userId, updateState: $input.item.json.updateState } };"
      },
      "id": "create-count-reply",
      "name": "ä»¶æ•°é¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 200]
    },
    {
      "parameters": {
        "functionCode": "const themes = [\n  'æœˆæ›œ_ã‚®ãƒ£ãƒ³ãƒ–ãƒ«é‡‘',\n  'ç«æ›œ_ãƒ“ã‚¸ãƒã‚¹ã‚­ãƒ£ãƒªã‚¢',\n  'æ°´æ›œ_ç”Ÿæ´»ç¯€ç´„',\n  'æœ¨æ›œ_ç¤¾ä¼šãƒãƒƒãƒˆè£äº‹æƒ…',\n  'é‡‘æ›œ_å¥åº·ç¾å®¹',\n  'åœŸæ›œ_æ‹æ„›äººé–“é–¢ä¿‚',\n  'æ—¥æ›œ_è¶£å‘³éŠã³'\n];\n\nconst message = {\n  type: 'text',\n  text: 'ãƒ†ãƒ¼ãƒã‚’é¸ã‚“ã§ãã ã•ã„',\n  quickReply: {\n    items: themes.map(t => ({ type: 'action', action: { type: 'message', label: t, text: t } }))\n  }\n};\n\nreturn { json: { replyToken: $input.item.json.replyToken, message: message, userId: $input.item.json.userId, updateState: $input.item.json.updateState } };"
      },
      "id": "create-theme-reply",
      "name": "ãƒ†ãƒ¼ãƒé¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "command": "cd c:\\Repos\\note-articles\\tools && python hogey_algorithm.py --count {{ $json.generateParams.count }} --theme \"{{ $json.generateParams.theme }}\" --mode {{ $json.generateParams.type === 'trilogy' ? 'trilogy' : 'buzz' }} --output temp_{{ $json.userId }}.csv"
      },
      "id": "execute-python",
      "name": "Pythonå®Ÿè¡Œ",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1250, 420]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/reply",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer wC3gxIxXv1YSwIcHr9gSY30+xp8pmF8uPbCsAcNpAnOqI5e6m4VdBI3Dc4/tSg1DOjQdFxYV0285aXsK3mN/Oim0eJuQmnJbD28azHAhfBrxEFosh9kdykEMm9rbeMOpiMCKsQnP2Cg2g8S7girINwdB04t89/1O/w1cDnyilFU="
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "bodyParameters": {
          "parameters": [
            {
              "name": "replyToken",
              "value": "={{ $json.replyToken }}"
            },
            {
              "name": "messages",
              "value": "={{ JSON.stringify([$json.message]) }}"
            }
          ]
        },
        "options": {}
      },
      "id": "line-reply",
      "name": "LINEè¿”ä¿¡",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1650, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://host.docker.internal:5679/api/state/={{ $json.userId }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.updateState) }}",
        "options": {}
      },
      "id": "update-user-state",
      "name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹æ›´æ–°",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "functionCode": "const params = $input.item.json.generateParams;\nconst userId = $input.item.json.userId;\nconst replyToken = $input.item.json.replyToken;\nconst fs = require('fs');\nconst path = require('path');\n\nconst csvPath = `c:\\\\Repos\\\\note-articles\\\\tools\\\\temp_${userId}.csv`;\nlet csvContent;\ntry {\n  csvContent = fs.readFileSync(csvPath, 'utf-8');\n} catch(e) {\n  return { json: { replyToken: replyToken, message: { type: 'text', text: 'âŒ ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ' }, userId: userId } };\n}\n\nconst lines = csvContent.split('\\n').slice(1).filter(l => l.trim());\nconst posts = lines.map(line => {\n  const match = line.match(/^\"([^\"]+)\",\"([^\"]+)\",\"([^\"]+)\",\"([^\"]+)\",\"([^\"]+)\"$/);\n  if (match) {\n    return { text: match[1], theme: match[2], education_type: match[3], template_type: match[4], created_at: match[5] };\n  }\n  return null;\n}).filter(p => p !== null);\n\nif (posts.length === 0) {\n  return { json: { replyToken: replyToken, message: { type: 'text', text: 'âŒ æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' }, userId: userId } };\n}\n\nconst firstPost = posts[0];\nconst progressBar = 'â–ˆ' + 'â–‘'.repeat(9);\n\nconst message = {\n  type: 'text',\n  text: `ğŸ¶ æŠ•ç¨¿1/${posts.length}\\n${progressBar}\\n\\n${firstPost.text}\\n\\nãƒ†ãƒ¼ãƒ: ${firstPost.theme}`,\n  quickReply: {\n    items: [\n      { type: 'action', action: { type: 'postback', label: 'â¡ï¸ æ¬¡ã¸', data: `action=next&index=1` } },\n      { type: 'action', action: { type: 'message', label: 'âœ… å®Œäº†', text: 'å®Œäº†' } }\n    ]\n  }\n};\n\nreturn { json: { replyToken: replyToken, message: message, userId: userId, updateState: { state: 'viewing_posts', posts_data: JSON.stringify(posts), current_index: 0 } } };"
      },
      "id": "create-post-display",
      "name": "æŠ•ç¨¿è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 420]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.nextAction }}",
              "value2": "show_help"
            }
          ]
        }
      },
      "id": "switch-action-help",
      "name": "ãƒ˜ãƒ«ãƒ—è¡¨ç¤º?",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [1050, 500]
    },
    {
      "parameters": {
        "functionCode": "const message = {\n  type: 'text',\n  text: `ğŸ¶ ãƒ›ã‚²ãƒ¼ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ \\n\\nä½¿ã„æ–¹:\\n1. ã€Œmenu:generateã€ã§æŠ•ç¨¿ç”Ÿæˆ\\n2. ã€Œmenu:todayã€ã§ä»Šæ—¥ã®ãƒ†ãƒ¼ãƒ\\n3. ã€Œmenu:helpã€ã§ãƒ˜ãƒ«ãƒ—\\n\\nä»¶æ•°ã¨ãƒ†ãƒ¼ãƒã‚’é¸æŠã—ã¦æŠ•ç¨¿ã‚’ç”Ÿæˆã—ã¾ã™ã€‚`\n};\n\nreturn { json: { replyToken: $input.item.json.replyToken, message: message, userId: $input.item.json.userId } };"
      },
      "id": "create-help-message",
      "name": "ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 500]
    },
    {
      "parameters": {
        "functionCode": "const loadingMessage = { type: 'text', text: 'â³ ç”Ÿæˆä¸­...\\nã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„' };\nreturn { json: { replyToken: $input.item.json.replyToken, message: loadingMessage, userId: $input.item.json.userId, generateParams: $input.item.json.generateParams, updateState: $input.item.json.updateState } };"
      },
      "id": "create-loading-message",
      "name": "ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 400]
    }
  ],
  "connections": {
    "LINE Webhook": {
      "main": [[{ "node": "ã‚³ãƒãƒ³ãƒ‰è§£æ", "type": "main", "index": 0 }]]
    },
    "ã‚³ãƒãƒ³ãƒ‰è§£æ": {
      "main": [[{ "node": "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹å–å¾—", "type": "main", "index": 0 }]]
    },
    "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹å–å¾—": {
      "main": [[{ "node": "çŠ¶æ…‹åˆ¤å®š", "type": "main", "index": 0 }]]
    },
    "çŠ¶æ…‹åˆ¤å®š": {
      "main": [[
        { "node": "ä»¶æ•°é¸æŠè¡¨ç¤º?", "type": "main", "index": 0 },
        { "node": "ãƒ†ãƒ¼ãƒé¸æŠè¡¨ç¤º?", "type": "main", "index": 0 },
        { "node": "æŠ•ç¨¿ç”Ÿæˆå®Ÿè¡Œ?", "type": "main", "index": 0 },
        { "node": "ãƒ˜ãƒ«ãƒ—è¡¨ç¤º?", "type": "main", "index": 0 }
      ]]
    },
    "ä»¶æ•°é¸æŠè¡¨ç¤º?": {
      "main": [[{ "node": "ä»¶æ•°é¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ", "type": "main", "index": 0 }]]
    },
    "ãƒ†ãƒ¼ãƒé¸æŠè¡¨ç¤º?": {
      "main": [[{ "node": "ãƒ†ãƒ¼ãƒé¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ", "type": "main", "index": 0 }]]
    },
    "æŠ•ç¨¿ç”Ÿæˆå®Ÿè¡Œ?": {
      "main": [[{ "node": "ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", "type": "main", "index": 0 }]]
    },
    "ãƒ˜ãƒ«ãƒ—è¡¨ç¤º?": {
      "main": [[{ "node": "ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ", "type": "main", "index": 0 }]]
    },
    "ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸": {
      "main": [[
        { "node": "LINEè¿”ä¿¡", "type": "main", "index": 0 },
        { "node": "Pythonå®Ÿè¡Œ", "type": "main", "index": 0 }
      ]]
    },
    "ä»¶æ•°é¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ": {
      "main": [[{ "node": "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹æ›´æ–°", "type": "main", "index": 0 }]]
    },
    "ãƒ†ãƒ¼ãƒé¸æŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ": {
      "main": [[{ "node": "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹æ›´æ–°", "type": "main", "index": 0 }]]
    },
    "ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ": {
      "main": [[{ "node": "LINEè¿”ä¿¡", "type": "main", "index": 0 }]]
    },
    "Pythonå®Ÿè¡Œ": {
      "main": [[{ "node": "æŠ•ç¨¿è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ", "type": "main", "index": 0 }]]
    },
    "æŠ•ç¨¿è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ": {
      "main": [[{ "node": "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹æ›´æ–°", "type": "main", "index": 0 }]]
    },
    "ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹æ›´æ–°": {
      "main": [[{ "node": "LINEè¿”ä¿¡", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "active": false
}
