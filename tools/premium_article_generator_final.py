#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Premium Article Generator - 完全版
データ構造に完全対応した100記事生成
"""

import json
import re
from pathlib import Path
from typing import Dict, List, Optional


def find_topic_by_keywords(title: str, category_data: Dict) -> Dict:
    """
    タイトルからキーワード抽出してtopicを検索
    """
    # 全topicのキーワードマッピング (完全版)
    keyword_map = {
        # Category 0: ギャンブル・金
        'パチ': ['パチンコ'],
        '競馬': ['競馬'],
        '競艇': ['競艇'],
        '競輪': ['競輪'],
        'FX': ['FX(裁量)'],
        '暗号資産': ['暗号資産(現物)', '暗号資産(草コイン)'],
        'バイナリー': ['バイナリーオプション'],
        'スポーツベッティング': ['スポーツベッティング'],
        '宝くじ': ['宝くじ'],
        'ポーカー': ['ポーカー(現金ゲーム)'],
        'クレカ': ['クレカリボ払い'],
        'リボ': ['クレカリボ払い'],
        '消費者金融': ['消費者金融'],
        '節税': ['節税スキーム誤用'],
        'ポイ活': ['ポイ活'],
        'ポイント': ['ポイ活'],
        
        # Category 1: ビジネス・キャリア
        '面接': ['面接'],
        '年収交渉': ['年収交渉'],
        '履歴書': ['履歴書・職務経歴書'],
        '職務経歴書': ['履歴書・職務経歴書'],
        '退職': ['退職'],
        '副業': ['副業'],
        '起業': ['起業'],
        'フリーランス': ['フリーランス'],
        '資格': ['資格取得'],
        '職場': ['職場人間関係'],
        'テレワーク': ['テレワーク'],
        'リモート': ['テレワーク'],
        '会議': ['会議'],
        '上司': ['上司報告'],
        'ビジネスメール': ['ビジネスメール'],
        'メール': ['ビジネスメール'],
        '営業': ['営業'],
        'タスク': ['タスク管理'],
        
        # Category 2: 生活・節約
        '不動産': ['不動産投資'],
        '住宅ローン': ['住宅ローン'],
        '生命保険': ['生命保険'],
        '保険': ['生命保険'],
        '電子マネー': ['電子マネー・キャッシュレス'],
        'キャッシュレス': ['電子マネー・キャッシュレス'],
        '相続': ['相続'],
        '家事': ['家事時短'],
        'お小遣い': ['子どものお小遣い'],
        '掃除': ['掃除'],
        '光熱費': ['光熱費'],
        '家計': ['家計管理'],
        '買い物': ['買い物'],
        '料理': ['料理'],
        '収納': ['収納'],
        '通信費': ['通信費'],
        '家庭': ['家庭内トラブル'],
        
        # Category 3: 社会・ネット裏事情
        'ふるさと': ['ふるさと納税'],
        '金融詐欺': ['金融詐欺'],
        '詐欺': ['金融詐欺', '詐欺メール・SMS'],
        '政治': ['政治ニュース'],
        '詐欺メール': ['詐欺メール・SMS'],
        'フィッシング': ['詐欺メール・SMS'],
        'ネット広告': ['ネット広告'],
        '広告': ['ネット広告'],
        'アプリ課金': ['アプリ課金'],
        'クラウド': ['クラウドサービス'],
        'ネット人間関係': ['ネット人間関係'],
        'SNS炎上': ['SNS炎上'],
        '炎上': ['SNS炎上'],
        '交通': ['交通トラブル'],
        'ショッピング': ['ショッピングサイト'],
        'レビュー': ['レビュー'],
        'ネット副業': ['ネット副業'],
        '公共': ['公共サービス'],
        'フリマ': ['フリマ(メルカリ・ラクマ)'],
        'メルカリ': ['フリマ(メルカリ・ラクマ)'],
        
        # Category 4: 健康・美容
        'ダイエット': ['ダイエット'],
        '筋トレ': ['筋トレ'],
        '運動': ['筋トレ', 'ランニング'],
        'サプリ': ['サプリ'],
        'スキンケア': ['スキンケア'],
        '肌': ['スキンケア'],
        '睡眠': ['睡眠'],
        'プロテイン': ['プロテイン'],
        'ランニング': ['ランニング'],
        '美容医療': ['美容医療'],
        '整形': ['美容医療'],
        'ヘアケア': ['ヘアケア'],
        '髪': ['ヘアケア'],
        'コスメ': ['コスメ選び'],
        '腸活': ['腸活'],
        'メンタル': ['メンタルヘルス'],
        '歯': ['歯のケア'],
        'ストレス': ['ストレス解消'],
        'アンチエイジング': ['アンチエイジング'],
        
        # Category 5: 恋愛・人間関係
        'マッチング': ['マッチングアプリ'],
        'デート': ['デート'],
        '告白': ['告白'],
        'プロポーズ': ['告白'],
        '結婚': ['結婚'],
        '別れ': ['別れ話'],
        '友達': ['友達関係'],
        '友人': ['友達関係'],
        'LINE': ['LINE・SNS'],
        '飲み会': ['飲み会'],
        '謝罪': ['謝罪'],
        'プレゼント': ['プレゼント選び'],
        '家族': ['家族関係'],
        'ママ友': ['ママ友・パパ友'],
        'パパ友': ['ママ友・パパ友'],
        '嫌いな人': ['嫌いな人への対処'],
        'ご近所': ['ご近所トラブル'],
        '会話': ['会話'],
        
        # Category 6: 趣味・遊び
        'ゲーム課金': ['ゲーム課金'],
        'ゲーム': ['ゲーム課金'],
        '課金': ['ゲーム課金', 'アプリ課金'],
        '映画': ['映画・漫画'],
        '漫画': ['映画・漫画'],
        'マンガ': ['映画・漫画'],
        'アニメ': ['映画・漫画'],
        '音楽': ['音楽ストリーミング'],
        'ストリーミング': ['音楽ストリーミング'],
        'スポーツ観戦': ['スポーツ観戦'],
        '観戦': ['スポーツ観戦'],
        '旅行': ['旅行'],
        'カフェ': ['カフェ・飲食'],
        '飲食': ['カフェ・飲食'],
        'DIY': ['DIY'],
        '写真': ['写真撮影'],
        '撮影': ['写真撮影'],
        'ペット': ['ペット飼育'],
        '趣味グッズ': ['趣味グッズ購入'],
        '釣り': ['釣り'],
        '登山': ['登山'],
        'カードゲーム': ['カードゲーム'],
        'カメラ': ['カメラ機材'],
        'ボードゲーム': ['ボードゲーム']
    }
    
    # タイトルからキーワード抽出
    for keyword, topics in keyword_map.items():
        if keyword in title:
            # category_dataからtopicを検索
            for item in category_data.get('data', []):
                if item.get('topic') in topics:
                    return item
    
    # デフォルト (最初のtopic)
    if category_data.get('data'):
        return category_data['data'][0]
    
    return {'topic': 'Unknown', 'facts': []}


def extract_loss_amount(facts: List[str]) -> int:
    """
    factsから損失額を抽出
    """
    for fact in facts:
        match = re.search(r'[-年間]+([0-9]+)万', fact)
        if match:
            return int(match.group(1))
    return 100


def generate_article(
    article_id: int,
    title: str,
    day: str,
    category_data: Dict,
    next_title: Optional[str] = None
) -> str:
    """
    記事生成 (V4ロジック: factsそのまま表示)
    """
    topic_data = find_topic_by_keywords(title, category_data)
    facts = topic_data.get('facts', [])
    topic_name = topic_data.get('topic', 'Unknown')
    
    if not facts:
        facts = [f'{topic_name}のデータ収集中'] * 5
    
    loss_amount = extract_loss_amount(facts)
    
    while len(facts) < 5:
        facts.append(facts[0] if facts else 'データ収集中')
    
    article = f"""# {title}

---

## 【無料部分】タバコ1本吸う間に読める

俺は昔、知らずに年間{loss_amount}万円損してた。

でもある**3つのポイント**に気づいただけで、今は損しなくなった。

その3つのうち、**1つだけ無料で公開する**。

---

## ポイント① あなたの知らない損失

**理由:** 知識がないと確実に損する

実際のデータを見てくれ↓

### あなたが気づいていない損失

"""
    
    for i, fact in enumerate(facts[:5], 1):
        article += f"**{i}.** {fact}\n\n"
    
    article += f"""
つまり、知らないだけで**年間{loss_amount}万円以上損する**可能性がある。

---

俺も昔は知らなくて大損した。

でも「データを知って行動を変える」だけで人生変わった。マジで。

---

### お前も当てはまってないか？

・業者/他人の言いなり
・比較検討しない
・最新情報を知らない

全部**カモフラグ**だぞ。

---

## 残り2つも知りたい？

無料で公開したのは**ポイント①だけ**。

残り2つのポイントを知れば、**年間{loss_amount}万円は確実に守れる**。

---

タバコ1箱分(300円)で読める。

300円ケチって今年も{loss_amount}万円損するか、300円払って守るか。

お前次第。

---

---

## 【有料部分】¥300

おう、300円払ったな。賢い選択だ。

ここから先は本当にヤバい裏側を晒す。

---

## なんでこんなに損する奴が多いのか

{title}の裏事情、知ってるか?

### 業界が隠したがる事実

"""
    
    if len(facts) > 1:
        article += f"**{facts[1]}**\n\n"
    if len(facts) > 2:
        article += f"**{facts[2]}**\n\n"
    
    article += """
業者・インフルエンサー・詐欺師は、お前が無知なまま損してくれた方が儲かる。
だから公式には絶対に教えない情報がある。

「お客様第一」とか言いながら、実は手数料ボッタクリ商品を売りつけてる。

ガチでエグい。

---

## じゃあどうすればいいのか

### ステップ1: **損失パターンを避ける**

以下のパターンは確実に損する↓

"""
    
    article += f"❌ **パターン①:** {facts[0]}\n\n"
    if len(facts) > 3:
        article += f"❌ **パターン②:** {facts[3]}\n\n"
    if len(facts) > 4:
        article += f"❌ **パターン③:** {facts[4]}\n\n"
    
    article += f"""
これらを避けるだけで**年間{loss_amount}万円は守れる**。マジで。

---

### ステップ2: **正しい行動を取る**

逆に損しない行動はここだ↓

⭕ **行動①: データを知る**
→ 上記の損失パターンを全部頭に入れる

⭕ **行動②: 3社以上比較する**
→ 面倒くさがらずに比較。それだけで半額になることも

⭕ **行動③: 最新情報を常にチェック**
→ 制度・トレンドは毎年変わる。古い知識は損する

この3つを守れば**年間{loss_amount}万円は確実に守れる**。
俺も実際に試して損しなくなった。

---

### ステップ3: **プロが使う裏ワザ**

損しない奴・成功してる奴は全員これやってる。

**1. 業者の提案を鵜呑みにしない**
→ セカンドオピニオン必須。専門家・経験者に相談

**2. キャンペーン・特典・裏技を徹底活用**
→ 時期・方法によっては数万~数十万円の差がつく

**3. 定期的に見直す(年1回は必須)**
→ 契約・習慣したら終わりじゃない。毎年最適化しろ

この3つを満たせばさらに年{int(loss_amount * 0.5)}万円浮く。
俺はこれで年間トータル{int(loss_amount * 1.5)}万円守ってる。ガチで。

---

## 実際どれくらい得するのか

| 項目 | 損失額 |
|------|--------|
"""
    
    for i, fact in enumerate(facts[:3], 1):
        short_fact = fact[:30] + '...' if len(fact) > 30 else fact
        article += f"| {short_fact} | 確認推奨 |\n"
    
    article += f"""| **年間合計** | **約{loss_amount}万円の損失リスク** |

つまり、**年間{loss_amount}万円は確実に守れる可能性がある**。

守った金でタバコ買うもよし、次の投資に回すもよし、貯金して少しマシな生活するもよし。お前の自由だ。

---

## 最後に

周りのバカどもは知らずに損し続けてる。

でもこれを読んだお前は違う。

**年間{loss_amount}万円守る知識**を手に入れた。

あとは行動するだけ。

---

300円払ったのはデカい投資だ。

今年は絶対に損するな。

---
"""
    
    if next_title:
        article += f"""
## 次回予告

次は「{next_title}」で、さらにヤバい裏側を暴露する。

また300円で読める。楽しみに待ってろ。

---
"""
    
    return article


def main():
    """
    メイン処理: 全7カテゴリ100記事生成 (完全版)
    """
    print("🔥 Premium Article Generator - 完全版 (100記事)")
    print()
    
    # データ読み込み
    data_file = Path(__file__).parent / 'data_collection_output.json'
    with open(data_file, 'r', encoding='utf-8') as f:
        all_data = json.load(f)
    
    # 全記事定義 (データ構造完全対応)
    # ID, 曜日, タイトル, カテゴリindex
    articles = [
        # カテゴリ0: ギャンブル・金 (15 topics)
        (1, '月曜', '【パチで負ける台の見分け方】', 0),
        (2, '月曜', '【競馬で確実に負ける買い方】', 0),
        (8, '月曜', '【FXで絶対やってはいけないこと】', 0),
        (9, '月曜', '【暗号資産で損する買い方】', 0),
        (15, '月曜', '【節税で逆に損する方法】', 0),
        (22, '月曜', '【クレカ・リボ払いで破産する使い方】', 0),
        (29, '月曜', '【消費者金融で借金地獄になる借り方】', 0),
        (36, '月曜', '【ポイント活用で損する貯め方】', 0),
        (43, '月曜', '【宝くじで確実に損する買い方】', 0),
        (50, '月曜', '【ポーカーで負けるプレイ方法】', 0),
        (57, '月曜', '【競艇で確実に負ける買い方】', 0),
        (64, '月曜', '【競輪で損する買い方】', 0),
        (71, '月曜', '【バイナリーオプションで損する方法】', 0),
        (78, '月曜', '【スポーツベッティングで負ける賭け方】', 0),
        
        # カテゴリ1: ビジネス・キャリア (15 topics)
        (3, '火曜', '【面接で絶対落ちる回答】', 1),
        (10, '火曜', '【履歴書・職務経歴書で損する書き方】', 1),
        (16, '火曜', '【年収交渉で失敗する交渉術】', 1),
        (23, '火曜', '【退職で損する辞め方】', 1),
        (30, '火曜', '【副業選びで失敗する選択】', 1),
        (37, '火曜', '【起業準備で失敗する準備不足】', 1),
        (44, '火曜', '【フリーランス独立で失敗する準備】', 1),
        (51, '火曜', '【資格取得で無駄金を使う選び方】', 1),
        (58, '火曜', '【職場の人間関係で孤立する行動】', 1),
        (65, '火曜', '【テレワークで評価が下がる働き方】', 1),
        (72, '火曜', '【会議で嫌われる発言】', 1),
        (79, '火曜', '【上司への報告で評価が下がる方法】', 1),
        (86, '火曜', '【ビジネスメールで嫌われる書き方】', 1),
        (93, '火曜', '【営業で絶対売れない方法】', 1),
        
        # カテゴリ2: 生活・節約 (15 topics)
        (4, '水曜', '【不動産投資で確実に失敗する物件選び】', 2),
        (11, '水曜', '【住宅ローンで損する組み方】', 2),
        (17, '水曜', '【生命保険で損する入り方】', 2),
        (24, '水曜', '【電子マネーで損する使い方】', 2),
        (31, '水曜', '【相続で家族が揉める対策】', 2),
        (38, '水曜', '【家事時短で逆に時間がかかる方法】', 2),
        (45, '水曜', '【子どものお小遣いで失敗する与え方】', 2),
        (52, '水曜', '【掃除で逆に汚れる方法】', 2),
        (59, '水曜', '【光熱費で損する使い方】', 2),
        (66, '水曜', '【家計管理で貯金できない方法】', 2),
        (73, '水曜', '【買い物で損する買い方】', 2),
        (80, '水曜', '【料理で時間と金を無駄にする方法】', 2),
        (87, '水曜', '【収納で逆に散らかる方法】', 2),
        (94, '水曜', '【通信費で損する契約方法】', 2),
        
        # カテゴリ3: 社会・ネット裏事情 (15 topics)
        (5, '木曜', '【ふるさと納税で損する選び方】', 3),
        (12, '木曜', '【金融詐欺に騙される人の特徴】', 3),
        (18, '木曜', '【政治ニュースで騙される情報収集】', 3),
        (25, '木曜', '【詐欺メール・SMSに引っかかる危険な行動】', 3),
        (32, '木曜', '【ネット広告で騙される広告の見分け方】', 3),
        (39, '木曜', '【アプリ課金で後悔する課金方法】', 3),
        (46, '木曜', '【クラウドサービスで損する選び方】', 3),
        (53, '木曜', '【ネット人間関係で嫌われる行動】', 3),
        (60, '木曜', '【SNS炎上で絶対やってはいけない返信】', 3),
        (67, '木曜', '【交通トラブルで損する対応】', 3),
        (74, '木曜', '【ショッピングサイトで詐欺に遭う買い方】', 3),
        (81, '木曜', '【レビューで騙される見分け方】', 3),
        (88, '木曜', '【ネット副業で詐欺に遭う副業選び】', 3),
        (95, '木曜', '【公共サービスで損する使い方】', 3),
        
        # カテゴリ4: 健康・美容 (15 topics)
        (6, '金曜', '【ダイエットで絶対失敗する食事法】', 4),
        (13, '金曜', '【筋トレで怪我する方法】', 4),
        (19, '金曜', '【サプリで逆効果になる飲み方】', 4),
        (26, '金曜', '【スキンケアで肌荒れする方法】', 4),
        (33, '金曜', '【睡眠で疲れが取れない習慣】', 4),
        (40, '金曜', '【プロテインで太る飲み方】', 4),
        (47, '金曜', '【ランニングで怪我する方法】', 4),
        (54, '金曜', '【美容医療で失敗するクリニック選び】', 4),
        (61, '金曜', '【ヘアケアで髪が傷む方法】', 4),
        (68, '金曜', '【コスメで肌荒れする選び方】', 4),
        (75, '金曜', '【腸活で逆効果になる方法】', 4),
        (82, '金曜', '【メンタルヘルスで悪化する対処法】', 4),
        (89, '金曜', '【歯のケアで虫歯になる方法】', 4),
        (96, '金曜', '【アンチエイジングで老ける習慣】', 4),
        
        # カテゴリ5: 恋愛・人間関係 (15 topics)
        (7, '土曜', '【マッチングアプリで出会えない使い方】', 5),
        (14, '土曜', '【デートで嫌われる行動】', 5),
        (20, '土曜', '【告白・プロポーズで断られる方法】', 5),
        (27, '土曜', '【結婚準備で揉める準備不足】', 5),
        (34, '土曜', '【別れ話で恨まれる切り出し方】', 5),
        (41, '土曜', '【友達関係で嫌われる行動】', 5),
        (48, '土曜', '【LINE・SNSで嫌われるメッセージ】', 5),
        (55, '土曜', '【飲み会で嫌われる行動】', 5),
        (62, '土曜', '【謝罪で逆に怒られる謝り方】', 5),
        (69, '土曜', '【プレゼントで嫌われる選び方】', 5),
        (76, '土曜', '【家族関係で揉める対応】', 5),
        (83, '土曜', '【ママ友・パパ友で孤立する行動】', 5),
        (90, '土曜', '【嫌いな人への対処で悪化する方法】', 5),
        (97, '土曜', '【ご近所トラブルで絶対やってはいけないこと】', 5),
        
        # カテゴリ6: 趣味・遊び (15 topics)
        (21, '日曜', '【ゲーム課金で後悔する課金方法】', 6),
        (28, '日曜', '【映画・漫画で損する買い方】', 6),
        (35, '日曜', '【音楽ストリーミングで損しない聴き方】', 6),
        (42, '日曜', '【スポーツ観戦で損するチケット購入】', 6),
        (49, '日曜', '【旅行で高く払う予約方法】', 6),
        (56, '日曜', '【カフェ・飲食で損する使い方】', 6),
        (63, '日曜', '【DIYで失敗する材料選び】', 6),
        (70, '日曜', '【写真撮影で損する機材選び】', 6),
        (77, '日曜', '【ペット飼育で失敗する飼い方】', 6),
        (84, '日曜', '【趣味グッズで損する買い方】', 6),
        (91, '日曜', '【釣りで損する道具選び】', 6),
        (98, '日曜', '【登山で遭難する準備不足】', 6),
        (99, '日曜', '【カードゲームで損する買い方】', 6),
        (100, '日曜', '【カメラ機材で損する選び方】', 6),
    ]
    
    # カテゴリ別フォルダ名
    category_folders = {
        0: '月曜_ギャンブル金',
        1: '火曜_ビジネスキャリア',
        2: '水曜_生活節約',
        3: '木曜_社会ネット裏事情',
        4: '金曜_健康美容',
        5: '土曜_恋愛人間関係',
        6: '日曜_趣味遊び'
    }
    
    # 出力ベースディレクトリ
    base_dir = Path(__file__).parent.parent / 'gethnote' / 'drafts'
    
    print(f"📝 全記事数: {len(articles)}")
    print(f"📁 出力先: {base_dir}")
    print()
    
    # 記事生成
    for i, (article_id, day, title, cat_idx) in enumerate(articles):
        category_data = all_data[cat_idx]
        next_title = articles[i + 1][2] if i + 1 < len(articles) else None
        
        article = generate_article(
            article_id=article_id,
            title=title,
            day=day,
            category_data=category_data,
            next_title=next_title
        )
        
        # フォルダ作成
        folder_name = category_folders[cat_idx]
        output_dir = base_dir / folder_name
        output_dir.mkdir(parents=True, exist_ok=True)
        
        # ファイル保存
        clean_title = title.replace('【', '').replace('】', '')
        filename = f"{article_id:03d}_{clean_title}.md"
        filepath = output_dir / filename
        
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(article)
        
        char_count = len(article)
        print(f"✅ [{day}] ID {article_id:3d} {title[:30]}... ({char_count}文字)")
    
    print()
    print(f"🎉 完了! 全 {len(articles)} 記事生成完了")
    print()
    print("📂 生成されたフォルダ:")
    for folder in category_folders.values():
        print(f"  - {folder}/")


if __name__ == '__main__':
    main()
