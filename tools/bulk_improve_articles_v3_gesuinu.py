#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ã’ã™ã„ã¬ç‰ˆ è¨˜äº‹ä¸€æ‹¬æ”¹å–„ã‚¹ã‚¯ãƒªãƒ—ãƒˆ v3
- èª­è€…æ”»æ’ƒã‚’å‰Šé™¤ï¼ˆã€ŒãŠå‰ã‚‰ã€â†’ã€Œã‚ãªãŸã€ã€ã€Œãƒã‚«ã€å‰Šé™¤ï¼‰
- ã’ã™ã„ã¬ã‚‰ã—ã•ã‚’ç¶­æŒï¼ˆã€Œä¿ºã€ã€Œã‚«ãƒ¢ã‚‰ã‚ŒãŸã€ã€Œã‚¯ã‚½æ¥­è€…ã€ã¯ä¿æŒï¼‰
- æ¥­ç•Œã¸ã®æ¯’ã«æ ¹æ‹ ã‚’è¿½åŠ 
"""

from pathlib import Path
import re
import sys


# è¨˜äº‹ãƒªã‚¹ãƒˆï¼ˆ100-113ï¼‰
ARTICLES = [
    (100, "NISAã§æã™ã‚‹éŠ˜æŸ„é¸ã³", 150),
    (101, "iDeCoã§æã™ã‚‹é‹ç”¨æ–¹æ³•", 80),
    (102, "æŠ•è³‡ä¿¡è¨—ã§æã™ã‚‹é¸ã³æ–¹", 100),
    (103, "ä½å®…ãƒ­ãƒ¼ãƒ³ã§æã™ã‚‹çµ„ã¿æ–¹", 500),
    (104, "ç”Ÿå‘½ä¿é™ºã§æã™ã‚‹å…¥ã‚Šæ–¹", 100),
    (105, "ãµã‚‹ã•ã¨ç´ç¨ã§æã™ã‚‹é¸ã³æ–¹", 6),
    (106, "æš—å·è³‡ç”£ã§è©æ¬ºã«é­ã†è²·ã„æ–¹", 218),
    (107, "å‰¯æ¥­ã§ç¨å‹™èª¿æŸ»ã•ã‚Œã‚‹ç”³å‘Šæ–¹æ³•", 20),
    (108, "ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ã§æã™ã‚‹ç‹¬ç«‹æº–å‚™", 100),
    (109, "é‡‘èè©æ¬ºã«é¨™ã•ã‚Œã‚‹äººã®ç‰¹å¾´", 520),
    (110, "ç›¸ç¶šã§å®¶æ—ãŒæ‰ã‚ã‚‹å¯¾ç­–ä¸è¶³", 500),
    (111, "æ³•äººè¨­ç«‹ã§æã™ã‚‹è¨­ç«‹æ–¹æ³•", 30),
    (112, "é›»å­ãƒãƒãƒ¼ã§æã™ã‚‹ä½¿ã„æ–¹", 10),
    (113, "ã‚¯ãƒ¬ã‚«ã§æã™ã‚‹é¸ã³æ–¹", 5),
]


def improve_article_gesuinu_v3(article_id, title, loss_amount):
    """
    ã’ã™ã„ã¬ç‰ˆv3åŸºæº–ã§è¨˜äº‹ã‚’æ”¹å–„
    """
    draft_dir = Path(__file__).parent.parent / 'gethnote' / 'drafts' / 'æœˆæ›œ_ã‚®ãƒ£ãƒ³ãƒ–ãƒ«é‡‘'
    filename = f"{article_id:03d}_{title}.md"
    filepath = draft_dir / filename
    
    if not filepath.exists():
        return False, f"ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {filepath}"
    
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            content = f.read()
        
        original_content = content
        
        # ===================================
        # 1. èª­è€…æ”»æ’ƒã®å‰Šé™¤ï¼ˆã’ã™ã„ã¬ã‚‰ã—ã•ã¯ç¶­æŒï¼‰
        # ===================================
        
        # ã€ŒãŠå‰ã‚‰ã€â†’ã€Œã‚ãªãŸã€ï¼ˆæœ€é‡è¦ï¼‰
        content = re.sub(r'ãŠå‰ã‚‰', r'ã‚ãªãŸ', content)
        content = re.sub(r'ãŠå‰', r'ã‚ãªãŸ', content)
        
        # èª­è€…ã‚’è¦‹ä¸‹ã™è¡¨ç¾ã‚’å‰Šé™¤
        content = re.sub(r'ãƒã‚«(ã©ã‚‚)?', r'æ°—ã¥ã„ã¦ãªã„äºº', content)
        content = re.sub(r'æƒ…å¼±', r'çŸ¥ã‚‰ãªã„äºº', content)
        content = re.sub(r'ã‚¢ãƒ›', r'æ°—ã¥ã„ã¦ãªã„', content)
        
        # ===================================
        # 2. ã’ã™ã„ã¬ã‚‰ã—ã•ã®ç¶­æŒ
        # ===================================
        
        # ã€Œä¿ºã€ã¯ãã®ã¾ã¾ç¶­æŒï¼ˆå¤‰æ›ã—ãªã„ï¼‰
        # ã€Œã‚«ãƒ¢ã‚‰ã‚ŒãŸã€ã‚‚ãã®ã¾ã¾ç¶­æŒ
        # ã€Œã‚¯ã‚½æ¥­è€…ã€ã€Œè©æ¬ºå¸«ã€ã‚‚ç¶­æŒ
        
        # ãŸã ã—ã€ã€Œç§ã€ã«ãªã£ã¦ã„ã‚‹ç®‡æ‰€ã‚’ã€Œä¿ºã€ã«æˆ»ã™ï¼ˆå°å…¥éƒ¨ã®ã¿ï¼‰
        # å°å…¥éƒ¨ãƒ‘ã‚¿ãƒ¼ãƒ³: "ç§ã‚‚ä»¥å‰ã¯" â†’ "ä¿ºã‚‚æ˜”ã¯"
        content = re.sub(
            r'ç§ã‚‚ä»¥å‰ã¯([^ã€‚]+)ã§ã€([^ã€‚]+)ã‚’å‡ºã—ã¦ã„ã¾ã—ãŸ',
            r'ä¿ºã‚‚æ˜”ã¯\1ã§ã€ãƒã‚¸ã§\2ã‚«ãƒ¢ã‚‰ã‚ŒãŸ',
            content
        )
        
        # ===================================
        # 3. æ¥­ç•Œæ‰¹åˆ¤ã«æ ¹æ‹ ã‚’è¿½åŠ ï¼ˆæ§‹é€ +æ„Ÿæƒ…ï¼‰
        # ===================================
        
        # ãƒ‘ã‚¿ãƒ¼ãƒ³1: ã€Œæ¥­è€…ã¯ã‚¯ã‚½ã€ã«æ§‹é€ èª¬æ˜ã‚’è¿½åŠ 
        if 'æ¥­è€…ã‚‚è©æ¬ºå¸«ã‚‚' in content or 'å…¨å“¡ã‚°ãƒ«' in content:
            content = re.sub(
                r'æ¥­è€…ã‚‚è©æ¬ºå¸«ã‚‚ã€å…¨å“¡ã‚°ãƒ«ã€‚',
                f'''æ¥­è€…ã¯ãƒã‚¸ã§ã‚¯ã‚½ã€‚

ãªãœã‹ï¼Ÿ
- è©•ä¾¡åˆ¶åº¦ãŒã€Œè²©å£²æ‰‹æ•°æ–™ã€ã§æ±ºã¾ã‚‹
- é¡§å®¢ãŒæã—ã¦ã‚‚è‡ªåˆ†ã¯å„²ã‹ã‚‹
- å•†å“ã‚’è¤‡é›‘ã«ã—ã¦æ¯”è¼ƒä¸å¯èƒ½ã«ã™ã‚‹

ã¤ã¾ã‚Šã€æ§‹é€ çš„ã«é¡§å®¢ã‚’æ¾å–ã™ã‚‹ä»•çµ„ã¿ã€‚''',
                content
            )
        
        # ãƒ‘ã‚¿ãƒ¼ãƒ³2: æ¥­ç•Œé–¢ä¿‚è€…ã®å¤šãã¯... â†’ ã’ã™ã„ã¬ç‰ˆã«æˆ»ã™
        content = re.sub(
            r'æ¥­ç•Œé–¢ä¿‚è€…ã®å¤šãã¯ã€é¡§å®¢åˆ©ç›Šã‚ˆã‚Šã‚‚æ‰‹æ•°æ–™åç›Šã‚’å„ªå…ˆã™ã‚‹æ§‹é€ çš„å•é¡ŒãŒã‚ã‚Šã¾ã™',
            r'æ¥­è€…ã¯ãƒã‚¸ã§ã‚¯ã‚½ã€‚è©•ä¾¡åˆ¶åº¦ãŒã€Œè²©å£²æ‰‹æ•°æ–™ã€ã§æ±ºã¾ã‚‹ã‹ã‚‰ã€é¡§å®¢ãŒæã—ã¦ã‚‚è‡ªåˆ†ã¯å„²ã‹ã‚‹ã€‚æ§‹é€ çš„ã«æ¾å–ã™ã‚‹ä»•çµ„ã¿',
            content
        )
        
        # ===================================
        # 4. é…æ…®è¡¨ç¾ã®èª¿æ•´ï¼ˆæœ€ä½é™ã«ï¼‰
        # ===================================
        
        # éå‰°ãªé…æ…®è¡¨ç¾ã‚’å‰Šé™¤
        content = re.sub(r'\n\ï¼ˆè²¬ã‚ã‚‹ã¤ã‚‚ã‚Šã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“ã€‚ç§ã‚‚ãã†ã§ã—ãŸ\ï¼‰', '', content)
        content = re.sub(r'\n\ï¼ˆè²¬ã‚ã‚‹ã¤ã‚‚ã‚Šã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“\ï¼‰', '', content)
        
        # ã‚·ãƒ³ãƒ—ãƒ«ãªé…æ…®è¡¨ç¾ã«ç½®ãæ›ãˆ
        if 'æ°—ã¥ã„ã¦ãªã„äººãŒå¤šã„' not in content and 'çŸ¥ã‚‰ãªã„äººãŒå¤šã„' not in content:
            # 1ç®‡æ‰€ã ã‘è¿½åŠ ï¼ˆæœ€ä½é™ï¼‰
            content = re.sub(
                r'(å¤šãã®æ–¹ã¯ä»Šæ—¥ã‚‚æ°—ã¥ã‹ãšã«)',
                r'\1ï¼ˆã‚ãªãŸã‚‚æ°—ã¥ã„ã¦ãªã„ã ã‘ã‹ã‚‚ã—ã‚Œãªã„ï¼‰',
                content,
                count=1
            )
        
        # ===================================
        # 5. åŠ±ã¾ã—ã‚’ã’ã™ã„ã¬é¢¨ã«
        # ===================================
        
        # ã€Œãœã²è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€â†’ã€Œã‚„ã‚‰ãªã„ã¨æã€
        content = re.sub(
            r'ä»¥ä¸Šã®æ–¹æ³•ã‚’è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚',
            f'''ã‚„ã‚‰ãªã„ã¨ãƒã‚¸ã§æã™ã‚‹ãã€‚

ä¿ºã¯{loss_amount}ä¸‡å††å¤±ã£ãŸã€‚
ã‚ãªãŸã¯ä»Šã‹ã‚‰å›é¿ã§ãã‚‹ã€‚

å‹•ãã‹ã€å‹•ã‹ãªã„ã‹ã€‚
ãã‚Œã ã‘ã®å·®ã€‚''',
            content
        )
        
        # ã€Œã¾ãšã¯1ã¤ã ã‘ã§ã‚‚è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€â†’ã’ã™ã„ã¬ç‰ˆ
        content = re.sub(
            r'ã¾ãšã¯1ã¤ã ã‘ã§ã‚‚è©¦ã—ã¦ã¿ã¦ãã ã•ã„',
            r'å…¨éƒ¨ã‚„ã‚‰ãªãã¦ã„ã„ã€‚1å€‹ã ã‘ã§ã‚‚ååˆ†ã€‚1å€‹ã‚„ã‚‹ã ã‘ã§ã€ä½•ã‚‚ã—ãªã„ã‚ˆã‚Šç¢ºå®Ÿã«ãƒã‚·',
            content
        )
        
        # ===================================
        # 6. å°å…¥éƒ¨ã®å¼·åŒ–ï¼ˆã’ã™ã„ã¬ç‰ˆå…±æ„Ÿæ–‡ï¼‰
        # ===================================
        
        # æ—¢å­˜ã®å°å…¥éƒ¨ã‚’æ¢ã™
        intro_pattern = r'(# .+?\n\n)(.+?\n\n)'
        match = re.search(intro_pattern, content)
        
        if match and 'ä¿º' not in match.group(2):
            # å°å…¥éƒ¨ã«ã’ã™ã„ã¬ç‰ˆå…±æ„Ÿæ–‡ã‚’æŒ¿å…¥
            gesuinu_intro = f'''ä¿ºã¯æ˜”ã€ä½•ã‚‚çŸ¥ã‚‰ãªãã¦{loss_amount}ä¸‡å††ã‚«ãƒ¢ã‚‰ã‚ŒãŸã€‚
ãƒã‚¸ã§æ‚”ã—ã‹ã£ãŸã€‚

ã‚ãªãŸã‚‚æ°—ã¥ã„ã¦ãªã„ã ã‘ã§ã€åŒã˜çŠ¶æ³ã‹ã‚‚ã—ã‚Œãªã„ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€ä¿ºãŒ{loss_amount}ä¸‡å††ã®æˆæ¥­æ–™ã‚’æ‰•ã£ã¦å­¦ã‚“ã ã“ã¨ã‚’å…¨éƒ¨æ›¸ãã€‚
åŒã˜ç›®ã«é­ã£ã¦ã»ã—ããªã„ã‹ã‚‰ã€‚

'''
            content = re.sub(
                intro_pattern,
                r'\1' + gesuinu_intro + r'\2',
                content,
                count=1
            )
        
        # ===================================
        # 7. å¤‰æ›´ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        # ===================================
        
        if content == original_content:
            return True, "å¤‰æ›´ãªã—ï¼ˆã™ã§ã«v3åŸºæº–ã‚’æº€ãŸã—ã¦ã„ã‚‹ï¼‰"
        
        # ===================================
        # 8. ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãæˆ»ã—
        # ===================================
        
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(content)
        
        return True, "æ”¹å–„å®Œäº†"
        
    except Exception as e:
        return False, f"ã‚¨ãƒ©ãƒ¼: {str(e)}"


def main():
    """
    ãƒ¡ã‚¤ãƒ³å‡¦ç†
    """
    print("=" * 60)
    print("ğŸ• ã’ã™ã„ã¬ç‰ˆ è¨˜äº‹ä¸€æ‹¬æ”¹å–„ v3")
    print("=" * 60)
    print()
    print("ã€æ”¹å–„å†…å®¹ã€‘")
    print("âœ… èª­è€…æ”»æ’ƒå‰Šé™¤: ã€ŒãŠå‰ã‚‰ã€â†’ã€Œã‚ãªãŸã€ã€ã€Œãƒã‚«ã€â†’ã€Œæ°—ã¥ã„ã¦ãªã„äººã€")
    print("âœ… ã’ã™ã„ã¬ç¶­æŒ: ã€Œä¿ºã€ã€Œã‚«ãƒ¢ã‚‰ã‚ŒãŸã€ã€Œã‚¯ã‚½æ¥­è€…ã€ã¯ãã®ã¾ã¾")
    print("âœ… æ¥­ç•Œæ‰¹åˆ¤å¼·åŒ–: æ§‹é€ å•é¡Œ+æ„Ÿæƒ…è¡¨ç¾ã®MIX")
    print("âœ… åŠ±ã¾ã—å¼·åŒ–: ã€Œã‚„ã‚‰ãªã„ã¨æã€ã§èƒŒä¸­æŠ¼ã—")
    print()
    print("=" * 60)
    print()
    
    success_count = 0
    skip_count = 0
    fail_count = 0
    
    for article_id, title, loss_amount in ARTICLES:
        print(f"å‡¦ç†ä¸­: [{article_id:03d}] {title}...", end=" ")
        
        success, message = improve_article_gesuinu_v3(article_id, title, loss_amount)
        
        if success:
            if "å¤‰æ›´ãªã—" in message:
                print(f"â­ï¸  {message}")
                skip_count += 1
            else:
                print(f"âœ… {message}")
                success_count += 1
        else:
            print(f"âŒ {message}")
            fail_count += 1
    
    print()
    print("=" * 60)
    print("ğŸ‰ å‡¦ç†å®Œäº†")
    print("=" * 60)
    print(f"æˆåŠŸ: {success_count}è¨˜äº‹")
    print(f"ã‚¹ã‚­ãƒƒãƒ—: {skip_count}è¨˜äº‹ï¼ˆã™ã§ã«v3åŸºæº–ï¼‰")
    print(f"å¤±æ•—: {fail_count}è¨˜äº‹")
    print()
    
    if success_count > 0:
        print("ğŸ“Š æ”¹å–„å†…å®¹:")
        print("   âœ… èª­è€…æ”»æ’ƒâ†’ä¸¦èµ°å§¿å‹¢")
        print("   âœ… ã’ã™ã„ã¬ã‚‰ã—ã•ç¶­æŒ")
        print("   âœ… æ¥­ç•Œã¸ã®æ¯’+æ ¹æ‹ ")
        print("   âœ… å¼·ã‚ã®èƒŒä¸­æŠ¼ã—")
    
    return 0 if fail_count == 0 else 1


if __name__ == '__main__':
    sys.exit(main())
